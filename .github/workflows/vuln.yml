---
name: check vulns

"on":
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'
env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  check:
    name: check vulns
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: checkout project
        uses: actions/checkout@755da8c3cf115ac066823e79a1e1788f8940201b
      - name: get base image
        id: base
        run: |
          set -x
          DIGEST="$(awk -F '=' '/ARG DIGEST/ {print $2}' Dockerfile)"
          echo "Base image: cgr.dev/chainguard/python@${DIGEST}"
          echo "image=cgr.dev/chainguard/python@${DIGEST}" >> $GITHUB_OUTPUT
      - name: install cosign
        uses: sigstore/cosign-installer@9becc617647dfa20ae7b1151972e9b3a2c338a2b
      # compare cve from latest base image (chainguard-images release)
      # and actually used base image inside rwalk image (flyio deploy)
      #
      # fail only if "now cve" > "latest cve" (trivy or grype)
      - name: cve count
        env:
          COSIGN_EXPERIMENTAL: 1
        run: |
          set -x
          CVE_COUNT=(-1 -1)
          CVE_LATEST_COUNT=(-1 -1)
          CVE_COUNT=($(cosign download attestation "${{ steps.base.outputs.image }}" \
            | jq -r .payload | base64 -d \
            | jq '.predicate.scanner.result.runs[0].results | length' | xargs))
          CVE_LATEST_COUNT=($(cosign download attestation cgr.dev/chainguard/python:latest-glibc \
            | jq -r .payload | base64 -d \
            | jq '.predicate.scanner.result.runs[0].results | length' | xargs))
          # stdout job summary
          echo "TRIVY_COUNT: ${CVE_COUNT[0]} vs ${CVE_LATEST_COUNT[0]}"
          echo "GRYPE_COUNT: ${CVE_COUNT[1]} vs ${CVE_LATEST_COUNT[1]}"
          # markdown job summary
          echo "### Check vulnerabilities summary" >> $GITHUB_STEP_SUMMARY
          echo >> $GITHUB_STEP_SUMMARY
          echo "|        |  TRIVY  |  GRYPE  |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|:-------:|:-------:|" >> $GITHUB_STEP_SUMMARY
          echo "| flyio  |  ${CVE_COUNT[0]}  |  ${CVE_COUNT[1]}  |" >> $GITHUB_STEP_SUMMARY
          echo "| latest |  ${CVE_LATEST_COUNT[0]}  |  ${CVE_LATEST_COUNT[1]}  |" >> $GITHUB_STEP_SUMMARY
          echo >> $GITHUB_STEP_SUMMARY
          # job fail logic
          [ ${CVE_COUNT[0]} -le ${CVE_LATEST_COUNT[0]} ] && [ ${CVE_COUNT[1]} -le ${CVE_LATEST_COUNT[1]} ] \
            || echo "#### rwalk deployed image insecure :x:" >> $GITHUB_STEP_SUMMARY
          echo "#### rwalk deployed image secure :heavy_check_mark:" >> $GITHUB_STEP_SUMMARY
